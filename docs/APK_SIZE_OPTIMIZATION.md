# APK Size Optimization

This document describes the APK size optimization implemented for the AgriConnect mobile app, reducing the APK size from ~137MB to ~75MB (45% reduction) while supporting both 32-bit and 64-bit ARM devices.

## Problem

The original APK size was approximately 137MB, which is too large for users with limited bandwidth or storage. This is common in React Native/Expo apps due to:
- Multiple ABI architectures bundled (arm64-v8a, armeabi-v7a, x86, x86_64)
- Unminified JavaScript and native code
- Unused code and resources not being stripped

## Solution

Two main optimizations were implemented:

### 1. R8/ProGuard Minification

R8 is Android's code shrinker that:
- Removes unused code (dead code elimination)
- Shortens class and method names (obfuscation)
- Optimizes bytecode
- Shrinks resources (removes unused resources)

### 2. Dual ABI Filter (armeabi-v7a + arm64-v8a)

Instead of bundling all four CPU architectures, we include both ARM architectures:
- **arm64-v8a**: 64-bit ARM for modern devices (2015+)
- **armeabi-v7a**: 32-bit ARM for older devices and some Android 12/14 devices
- Removes x86/x86_64 architectures (emulator-only, ~50% native library reduction)
- Supports virtually all physical Android devices

## Implementation

Since the `/android` folder is gitignored (generated by Expo prebuild), we use an Expo config plugin to apply these optimizations.

### Config Plugin: `app/plugins/withProguard.js`

```javascript
const {
  withGradleProperties,
  withDangerousMod,
} = require("expo/config-plugins");
const fs = require("fs");
const path = require("path");

function withProguard(config) {
  // Add gradle properties for minification and ABI filter
  config = withGradleProperties(config, (config) => {
    // Remove existing reactNativeArchitectures if present
    config.modResults = config.modResults.filter(
      (prop) => prop.key !== "reactNativeArchitectures"
    );

    // Add our properties
    config.modResults.push(
      {
        type: "property",
        key: "android.enableMinifyInReleaseBuilds",
        value: "true",
      },
      {
        type: "property",
        key: "android.enableShrinkResourcesInReleaseBuilds",
        value: "true",
      },
      {
        type: "property",
        key: "reactNativeArchitectures",
        value: "armeabi-v7a,arm64-v8a",
      }
    );
    return config;
  });

  // Add custom ProGuard rules
  config = withDangerousMod(config, [
    "android",
    async (config) => {
      const proguardRulesPath = path.join(
        config.modRequest.platformProjectRoot,
        "app",
        "proguard-rules.pro"
      );

      const customRules = `
# Hermes engine
-keep class com.facebook.hermes.unicode.** { *; }
-keep class com.facebook.jni.** { *; }

# Expo modules
-keep class expo.modules.** { *; }
-keepclassmembers class * {
    @expo.modules.core.interfaces.ExpoProp *;
}

# SQLCipher / expo-sqlite
-keep class net.sqlcipher.** { *; }
-keep class net.sqlcipher.database.* { *; }

# Firebase (for push notifications)
-keep class com.google.firebase.** { *; }
-keep class com.google.android.gms.** { *; }

# Keep native methods
-keepclassmembers class * {
    native <methods>;
}
`;

      // Read existing rules and append custom ones if not already present
      let existingRules = "";
      if (fs.existsSync(proguardRulesPath)) {
        existingRules = fs.readFileSync(proguardRulesPath, "utf-8");
      }

      // Only add if not already present
      if (!existingRules.includes("# Hermes engine")) {
        fs.writeFileSync(proguardRulesPath, existingRules + customRules);
      }

      return config;
    },
  ]);

  return config;
}

module.exports = withProguard;
```

### Registration in `app.config.js`

```javascript
plugins: [
  // ... other plugins
  "./plugins/withProguard",
],
```

## ProGuard Rules Explained

The custom ProGuard rules prevent critical classes from being stripped:

| Rule | Purpose |
|------|---------|
| `com.facebook.hermes.**` | Hermes JavaScript engine (required) |
| `com.facebook.jni.**` | JNI bindings for React Native |
| `expo.modules.**` | Expo native modules |
| `net.sqlcipher.**` | SQLCipher encryption for expo-sqlite |
| `com.google.firebase.**` | Firebase Cloud Messaging (push notifications) |
| `native <methods>` | All JNI native method declarations |

## Results

| Version | Size | Notes |
|---------|------|-------|
| 1.2.7 | 138MB | Before optimization |
| 1.2.8 | 128MB | R8/ProGuard only (all ABIs) |
| 1.2.9 | 44MB | R8/ProGuard + arm64-v8a only |
| 1.3.0 | 44MB | arm64-v8a only |
| 1.3.3 | ~75MB | R8/ProGuard + Dual ABI (armeabi-v7a + arm64-v8a) |

**Total reduction: ~45% (138MB â†’ ~75MB)** with full device compatibility

## Building the Optimized APK

```bash
# From the app directory
cd app

# Run the build script
./build-android.sh

# The APK will be at:
# android/app/build/outputs/apk/release/app-release.apk
```

## Deployment

After building, deploy the APK to production storage:

```bash
# Copy to Kubernetes pod
kubectl cp agriconnect.apk agriconnect2-namespace/<pod-name>:/app/storage/agriconnect-X.Y.Z.apk

# Also update the default agriconnect.apk
kubectl exec -n agriconnect2-namespace <pod-name> -c backend -- \
  cp /app/storage/agriconnect-X.Y.Z.apk /app/storage/agriconnect.apk
```

## Considerations

### Device Compatibility

- **armeabi-v7a + arm64-v8a**: Supports virtually all physical Android devices
- **arm64-v8a**: 64-bit ARM devices (most devices since 2015)
- **armeabi-v7a**: 32-bit ARM devices and some older devices running Android 12/14
- **x86/x86_64**: Not included (emulator-only architectures)
- If you need emulator support for testing, temporarily add x86_64 to the architectures

### Troubleshooting

If the app crashes after optimization:

1. **Check ProGuard rules**: Add `-keep` rules for any classes that are accessed via reflection
2. **Check native libraries**: Ensure all required native libraries have keep rules
3. **Test thoroughly**: R8 optimization can sometimes strip seemingly unused but actually required code

### Adding New Keep Rules

If a new library requires ProGuard rules, add them to `app/plugins/withProguard.js`:

```javascript
const customRules = `
# Existing rules...

# New library
-keep class com.newlibrary.** { *; }
`;
```

## Related Issues

- GitHub Issue #131: APK size optimization
- GitHub Issue #132: App version check and update feature

## References

- [Android R8 Documentation](https://developer.android.com/studio/build/shrink-code)
- [Expo Config Plugins](https://docs.expo.dev/config-plugins/introduction/)
- [ProGuard Manual](https://www.guardsquare.com/manual/configuration/usage)
